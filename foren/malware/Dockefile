FROM alpine:latest

# Install only what's necessary (no upgrade, and no caching index)
RUN apk --no-cache add socat

# Create user securely (with no shell access and home directory as needed)
RUN adduser -D -H -u 1001 -s /sbin/nologin ctf

# Use the correct working directory
WORKDIR /home/ctf

# Copy only required files
COPY ./flag.txt ./flag.txt
COPY ./asker ./asker

# Set correct ownership and permissions
RUN chown -R ctf:ctf /home/ctf && \
    chmod 500 /home/ctf/asker && \
    chmod 400 /home/ctf/flag.txt

# Drop privileges to unprivileged user
USER ctf

# Expose the listening port
EXPOSE 1339

# Start socat securely without shell
CMD socat TCP-LISTEN:1339,reuseaddr,fork EXEC:"/home/ctf/asker",stderr

